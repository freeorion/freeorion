name: "Android"

on:
  workflow_call:
jobs:
  generate-godot-api:
    name: Generate Godot API
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/bend-n/godot:3.5.2
    steps:
      - name: Setup
        uses: bend-n/godot-actions/.github/actions/setup-godot@main
        env:
          GODOT_VERSION: "3.5.2"
      - name: Generate API file
        run: |
          timeout 1m godot --no-window --disable-render-loop --video-driver Dummy --gdnative-generate-json-api godot-api.json
      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: godot-api
          path: godot-api.json
          if-no-files-found: error
          retention-days: 1
  android:
    name: ${{ matrix.arch }}
    runs-on: ubuntu-latest
    needs: generate-godot-api
    strategy:
      matrix:
        arch: [x86, x86_64, armeabi-v7a, arm64-v8a]
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4
      - name: Dowload Godot API
        uses: actions/download-artifact@v4
        with:
          name: godot-api
          path: .
      - name: Download SDK
        id: download-sdk
        uses: suisei-cn/actions-download-file@v1.4.0
        with:
          url: https://github.com/freeorion/freeorion-sdk/releases/download/v17/FreeOrionSDK_17_Android-${{ matrix.arch }}.zip
          target: ../
      - uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r24
          add-to-path: false
      - name: Configure
        run: |
          unzip -q ../${{ steps.download-sdk.outputs.filename }} -d ..
          GODOT_API_JSON=$(realpath godot-api.json)
          mkdir build
          pushd build
          FO_SDK=$(realpath ../..)
          cmake -DANDROID_ABI=${{ matrix.arch }} -DANDROID_PLATFORM=24 -DANDROID_NDK=${{ steps.setup-ndk.outputs.ndk-path }} -DCMAKE_BUILD_TYPE=MinSizeRel -DCMAKE_TOOLCHAIN_FILE=${{ steps.setup-ndk.outputs.ndk-path }}/build/cmake/android.toolchain.cmake -DCMAKE_CXX_FLAGS=-std=c++14 -DANDROID_ALLOW_UNDEFINED_SYMBOLS=Off -DBUILD_SERVER=OFF -DBUILD_AI=OFF -DBUILD_CLIENT_GG=OFF -DBoost_INCLUDE_DIR=${FO_SDK}/include/ -DBoost_USE_STATIC_LIBS=On -DBoost_LIBRARY_DIR=${FO_SDK}/lib/ -DBUILD_CLIENT_GODOT=On -DICUI18N_LIBRARY=${FO_SDK}/lib/libicui18n.a -DICUUC_LIBRARY=${FO_SDK}/lib/libicuuc.a -DICUDATA_LIBRARY=${FO_SDK}/lib/libicudata.a -DICONV_LIBRARY=${FO_SDK}/lib/libiconv.so -DPython3_LIBRARY=${FO_SDK}/lib/libpython3.10.a -DPython3_INCLUDE_DIR=${FO_SDK}/include/python3.10/ -DGODOT_CUSTOM_API_FILE=${GODOT_API_JSON} ..
      - name: Build
        run: |
          pushd build
          cmake --build . -- -j4
      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: android-binaries-${{ matrix.arch }}
          path: godot/bin/
          if-no-files-found: error
          retention-days: 1
  merge-binaries:
    name: Merge binaries
    runs-on: ubuntu-latest
    needs: android
    steps:
      - name: Merge binaries
        uses: actions/upload-artifact/merge@v4
        with:
          name: android-binaries
          pattern: android-binaries-*
          delete-merged: true
          retention-days: 1
  export-android:
    name: Export Android
    runs-on: ubuntu-22.04
    needs: merge-binaries
    container:
      image: ghcr.io/bend-n/godot:3.5.2
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4
      - name: Setup
        uses: bend-n/godot-actions/.github/actions/setup-godot@main
        env:
          GODOT_VERSION: "3.5.2"
      - name: Download python library
        id: download-python-lib
        uses: suisei-cn/actions-download-file@v1.3.0
        with:
          url: https://github.com/freeorion/freeorion-sdk/releases/download/v17/python310.zip
          target: ../
      - name: Place resources
        run: |
          mkdir -p godot/default/python/lib/
          cp ../${{ steps.download-python-lib.outputs.filename }} godot/default/python/lib/python310.zip
          unzip -t godot/default/python/lib/python310.zip
          mv default/data/art godot/assets/
          mv default/data/fonts godot/assets/
          mv default/data/sound godot/assets/
          mv default/scripting godot/default/
          mv default/stringtables godot/default/
      - name: Dowload binaries
        uses: actions/download-artifact@v4
        with:
          name: android-binaries
          path: godot/bin/
      - name: Build
        uses: bend-n/godot-actions/.github/actions/export-android@main
        env:
          GODOT_VERSION: "3.5.2"
          NAME: freeorion
          PROJECT_PATH: godot
  run-android:
    name: Run Android
    runs-on: ubuntu-24.04
    needs: export-android
    steps:
      - uses: actions/cache@v3
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
            ~/.android/debug.keystore
          key: avd-test-godot
      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
      - name: run emulator to generate snapshot for caching
        if: steps.avd-cache.outputs.cache-hit != 'true'
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          target: google_apis
          arch: x86_64
          profile: Galaxy Nexus
          cores: 2
          sdcard-path-or-size: 100M
          emulator-build: 7425822 # https://github.com/ReactiveCircus/android-emulator-runner/issues/160
          avd-name: test
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: false
          working-directory: ./
          channel: beta
          script: echo "Generated AVD snapshot for caching."
      - name: Dowload APK
        uses: actions/download-artifact@v4
        with:
          name: android
          path: .
      - name: run game on emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          target: google_apis
          arch: x86_64
          profile: Galaxy Nexus
          cores: 2
          sdcard-path-or-size: 100M
          emulator-build: 7425822 # https://github.com/ReactiveCircus/android-emulator-runner/issues/160
          avd-name: test
          force-avd-creation: false
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: false
          working-directory: ./
          channel: beta
          script: |
            adb devices
            adb install freeorion.apk
            adb logcat -c
            adb shell am start -W -n org.godotengine.freeoriongodotclient/com.godot.game.GodotApp
            sleep 180
            adb shell am force-stop org.godotengine.freeoriongodotclient
            adb logcat -d >logcat.log
            adb exec-out run-as org.godotengine.freeoriongodotclient cat files/freeorion-godot.log >freeorion-godot.log 2>&1
            echo ".. check errors .."
            ! grep "\[error\] godot : \(Parse\|ReportParseError\)" freeorion-godot.log
            echo ".. check finish .."
            grep "\[debug\] godot : FreeOrionNode.cpp:[0-9]\+ : FreeOrionNode::parsing_thread(): Freeorion parsing stopped" freeorion-godot.log
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-test-logs-${{ github.run_number }}
          path: |
            freeorion-godot.log
            logcat.log
          if-no-files-found: error
          retention-days: 1
